---
title: "Modeling"
author: "Chris Hill"
format: 
  html:
    toc: true
    toc-title: "Contents"
    toc-depth: 3
editor: visual
---

```{r}
#| label: setup

library(tidymodels)
library(doFuture)

registerDoFuture()
plan(multisession)

set.seed(123)
```

# Introduction



## Data Processing

```{r}
#| label: data-processing

data <- readRDS("processed_data.rds")
```

## Data Splitting

```{r}
#| label: data-split

split <- initial_split(data, prop = 0.7, strata = Diabetes_binary)
train_data <- training(split)
test_data <- testing(split)
```

## Metric

```{r}
#| label: metric

log_loss_metric <- metric_set(mn_log_loss, accuracy)
```

## Cross Validation

```{r}
#| label: cross-validation

folds <- vfold_cv(train_data, v = 5, strata = Diabetes_binary)
```

# Classification Tree

## Recipe

```{r}
#| label: tree-recipe

tree_recipe <- recipe(Diabetes_binary ~ BMI + Sex + Age + Income + HeartDiseaseorAttack, 
                      data = train_data) |>
  step_dummy(all_nominal_predictors(), -all_outcomes())
```

```{r}
#| label: tree-prep

prepared_recipe <- prep(tree_recipe)
baked <- bake(prepared_recipe, new_data = NULL)
baked
```

## Model

```{r}
#| label: tree-model

tree_model <- decision_tree(cost_complexity = tune()) |>
  set_engine("rpart") |>
  set_mode("classification")
```

## Workflow

```{r}
#| label: tree-workflow

tree_workflow <- workflow() |>
  add_recipe(tree_recipe) |>
  add_model(tree_model)
```

## Tuning

```{r}
#| label: tree-tuning
#| cache: true
#| dependson: "tree-model"

tree_grid <- grid_regular(cost_complexity(range = c(-6, -2)), 
                          levels = 10)

tree_tuning <- tune_grid(
  tree_workflow,
  resamples = folds,
  grid = tree_grid,
  metrics = log_loss_metric
)
```

## Best Model

```{r}
#| label: best-tree
#| cache: true
#| dependson: "tree-tuning"

best_tree <- tree_tuning |>
  select_best(metric = "mn_log_loss")
best_tree

final_tree_workflow <- finalize_workflow(tree_workflow, best_tree)

final_tree_model <- fit(final_tree_workflow, data = train_data)
```

# Random Forest

## Recipe

Same as the classification tree.

## Model

```{r}
#| label: rf-model

rf_model <- rand_forest(mtry = tune(), trees = 500) |>
  set_engine("ranger") |>
  set_mode("classification")
```

## Workflow

```{r}
#| label: rf-workflow

rf_workflow <- workflow() |>
  add_recipe(tree_recipe) |>
  add_model(rf_model)
```

## Tuning

```{r}
#| label: rf-tuning
#| cache: true
#| dependson: ["rf-model", "rf-workflow", "tree-model"]

rf_grid <- grid_regular(mtry(range = c(1, 5)), levels = 5)

rf_tuning <- tune_grid(
  rf_workflow,
  resamples = folds,
  grid = rf_grid,
  metrics = log_loss_metric
)
```

## Best Model

```{r}
#| label: best-rf
#| cache: true
#| dependson: "rf-tuning"

best_rf <- rf_tuning |>
  select_best(metric = "mn_log_loss")
best_rf

final_rf_workflow <- finalize_workflow(rf_workflow, best_rf)

final_rf_model <- fit(final_rf_workflow, data = train_data)
```

## Tuning Results Visualization

```{r}
#| label: tuning-results

tree_results <- collect_metrics(tree_tuning)
rf_results <- collect_metrics(rf_tuning)

bind_rows(
  tree_results |> mutate(model = "Tree"),
  rf_results |> mutate(model = "Random Forest")
) |> 
  ggplot(aes(x = .metric, y = mean, color = model)) +
  geom_point(position = position_dodge(0.3)) +
  geom_errorbar(aes(ymin = mean - std_err, ymax = mean + std_err), position = position_dodge(0.3)) +
  facet_wrap(~.metric, scales = "free_y") +
  labs(
    title = "Comparison of Model Metrics",
    x = "Metric",
    y = "Mean Value"
  ) +
  theme_minimal()
```

# Model Comparison

```{r}
#| label: model-comparison
#| cache: true
#| dependson: ["best-tree", "best-rf"]

tree_results <- final_tree_workflow |>
  last_fit(split, metrics = log_loss_metric) |>
  collect_metrics()

rf_results <- final_rf_workflow |>
  last_fit(split, metrics = log_loss_metric) |>
  collect_metrics()

list(
  Classification_Tree = tree_results,
  Random_Forest = rf_results
)
```

# Fit Best Model to Entire Dataset

```{r}
#| label: fit-full
#| cache: true
#| dependson: "best-rf"

final_rf_model_full <- fit(final_rf_workflow, data = data)

saveRDS(final_rf_model_full, "final_rf_model.rds")
```

